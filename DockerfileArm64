# docker image build --tag egoroff/bstore .

# Build service
FROM --platform=$BUILDPLATFORM messense/rust-musl-cross:aarch64-musl AS rust-build
RUN rustup toolchain uninstall stable-x86_64-unknown-linux-gnu && \
    rustup toolchain install stable-x86_64-unknown-linux-gnu && \
    rustup update stable && \
    rustup target add aarch64-unknown-linux-musl
COPY .cargo/ ./.cargo/
COPY bstore/ ./bstore/
COPY client/ ./client/
COPY server/ ./server/
COPY kernel/ ./kernel/
COPY Cargo.toml ./
RUN cargo build --workspace --target aarch64-unknown-linux-musl --release 

FROM gcr.io/distroless/static-debian13:latest
ENV BSTORE_PORT=5000 \
    BSTORE_DATA_DIR=/data/data \
    BSTORE_DATA_FILE=bstore.db

COPY --from=rust-build /home/rust/src/target/aarch64-unknown-linux-musl/release/bstore /usr/local/bin/bstore
ENTRYPOINT [ "/usr/local/bin/bstore" ]
CMD [ "server" ]
EXPOSE 5000
